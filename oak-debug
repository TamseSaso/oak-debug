#!/usr/bin/env bash
set -e

APP_PATH="${1:-.}"
DEVICE_IP="$2"
PORT=5555

if [ -z "$DEVICE_IP" ]; then
  echo "Usage: ./oak-debug <APP_PATH> <DEVICE_IP>"
  echo "Example: ./oak-debug . 192.168.1.198"
  exit 1
fi

echo "▶ Starting app on device..."
oakctl app run -d "$DEVICE_IP" "$APP_PATH" &

echo "▶ Waiting for web-pdb server at $DEVICE_IP:$PORT ..."
until nc -z "$DEVICE_IP" "$PORT"; do
  sleep 1
done

echo "▶ Web-PDB is ready!"
echo "▶ Opening web browser to http://$DEVICE_IP:$PORT"
echo ""

# Try to open browser (works on macOS, Linux with xdg-open, or Windows)
if command -v open >/dev/null 2>&1; then
  # macOS
  open "http://$DEVICE_IP:$PORT"
elif command -v xdg-open >/dev/null 2>&1; then
  # Linux
  xdg-open "http://$DEVICE_IP:$PORT"
elif command -v start >/dev/null 2>&1; then
  # Windows
  start "http://$DEVICE_IP:$PORT"
else
  echo "Please open your browser and navigate to: http://$DEVICE_IP:$PORT"
fi

wait